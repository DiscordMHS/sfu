VoiceClient Library Documentation
Overview VoiceClient is a specialized WebRTC wrapper designed for SFU-based architectures handling voice, video (camera), and screen sharing. The key architectural difference is that instead of adding and removing video tracks which triggers costly renegotiations, this library always sends a video track. In the idle state, it sends a 10x10 pixel black placeholder which consumes negligible bandwidth (around 10kbps). In the active state, it uses replaceTrack to swap the placeholder for the camera or screen stream instantly. Because the video track is always present, the UI must handle visibility based on custom signaling events via onRemoteMode, not based on whether a track exists.
Initialization To initialize, instantiate the VoiceClient class with a configuration object. This object should include iceServers (e.g., stun
.l.google.com:19302) and videoMaxBitrateKbps (default 3000). It must also provide callbacks: onTrack (fired when a new stream arrives, use this to create video/audio elements), onTrackEnded (fired when a track is removed, use this to clean up the DOM), onRemoteMode (fired when a peer toggles their video state, use this to toggle visibility), and onDisconnect.
API Methods client.join(wsUrl, token): Connects to the WebSocket and establishes the WebRTC session. It immediately requests microphone access and starts sending audio plus the placeholder video. It returns a Promise that resolves when the SDP Answer is received.
client.startCamera(): Swaps the placeholder video for the User's Webcam. It automatically stops Screen Share if active and sends an "Active" signal to peers via the websocket.
client.stopCamera(): Stops the Webcam and reverts to sending the Placeholder, sending an "Inactive" signal to peers.
client.startScreenShare(): Swaps the current video for Screen Capture. It automatically stops Camera if active and sends an "Active" signal to peers.
client.stopScreenShare(): Stops Screen Share and reverts to sending the Placeholder.
client.disconnect(): Closes WebSocket, PeerConnection, and stops all local media tracks.
Critical Implementation Details
The Hidden by Default Rule: Since the library always streams the placeholder, onTrack will fire for video immediately upon connection. Do not show the video immediately. UI elements for video should default to Muted/Hidden (CSS opacity: 0 or display: none) and show a User Inactive avatar instead.
Handling onRemoteMode (SSRC Lookup): When a remote user toggles their camera, the server sends a mode message containing an SSRC (Synchronization Source ID). You must map this SSRC to the specific DOM element to unhide it. Note that WebRTC stats take time to populate. You may receive the signal before the browser has fully registered the SSRC stats. You should implement a retry/polling loop (e.g., every 500ms for 5 attempts) that checks client.pc.getStats() for the inbound-rtp video report matching the SSRC to resolve the trackIdentifier, which corresponds to the MediaStreamTrack.id held by the video element.
Audio Handling: Audio is always active. You should create audio elements with autoplay in onTrack. You can remove controls or set display: none to hide the player while allowing it to play.
Common Pitfalls State Desync on Join: When a new user joins, if an existing user is sharing a camera, the library automatically re-broadcasts state on renegotiation to ensure the new user gets the active signal. SSRC Collision: Ensure your SFU generates unique SSRCs. The SSRC is the only link between the signaling message and the media track. UI Flicker: When switching from Camera to Screen, the placeholder is briefly active in the background. Keep the video container active during this transition for a seamless experience.